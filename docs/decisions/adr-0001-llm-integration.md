# ADR 0001: LLM Integration Strategy

<<AC_ANCHOR|DOC|DECISION|adr-llm-integration@v1>>
This architecture decision record establishes the initial strategy for
integrating external language model providers through a shared client library.
It aligns upcoming development with the contracts defined in
`/contracts/core.llm-client.v1.yaml` and `/contracts/plugin.contract.v1.yaml`.
<</AC_ANCHOR|DOC|DECISION|adr-llm-integration@v1>>

> Информация в этом документе может устареть; проверяйте ссылки на контракты и
> дорожную карту (`ROADMAP.md`).

## Статус
Accepted — 2025-09-17

## Контекст
- Платформе требуется единый способ общения с различными LLM-провайдерами, чтобы
  ядро и плагины могли переиспользовать инфраструктуру и соблюдать общие SLA.
- Контракт `core.llm-client.v1` задаёт высокоуровневые ожидания, но требует
  уточнённой стратегии адаптеров, управления провайдерами и телеметрии.
- Необходимо обеспечить совместимость с будущими плагинами, которые будут
  генерироваться автоматически и ожидать стабильный API клиента.

## Решение
- Вводится «профиль провайдера» (`/ops/config/llm-profiles.yaml`, файл будет
  создан в одной из следующих сессий) с параметрами таймаутов, ретраев и
  ограничений по стоимости.
- Ядро и плагины используют общий модуль `core.llm_client`, который предоставляет
  методы `generate` и `classify` (см. контракт) и реализует маршрутизацию по
  имени профиля.
- Для изоляции провайдеров применяется шаблон адаптера: каждый провайдер
  описывается отдельным классом с единым интерфейсом, регистрируемым через
  фабрику.
- Логи формируются в формате `LLMLOG|core.llm_client|...` и обогащаются
  идентификаторами запросов из ядра; чувствительные поля промптов подлежат
  редактированию перед записью.
- Метрики публикуются в `llm_client.request.latency` и
  `llm_client.request.failures` с тегами `provider`, `operation`, `retry`.

## Варианты
| Вариант | Плюсы | Минусы | Статус |
| --- | --- | --- | --- |
| Прямые обращения к провайдерам из каждого плагина | Простота реализации для одного провайдера | Утечка бизнес-логики в плагины, отсутствует единая политика безопасности | Отклонён |
| Выделенный сервис-обёртка над LLM | Централизованный контроль, изоляция секретов | Дополнительная латентность, сложность деплоя на старте | Отложен (переоценить при росте нагрузки) |
| **Общий клиент в репозитории (выбранный)** | Повторное использование кода, единые политики, простота тестирования | Требует дисциплины версионирования и управления зависимостями | Принят |

## Последствия
- Требуется разработать фабрику адаптеров и конфигурацию профилей до начала
  интеграции с реальными LLM.
- Контракт `core.llm-client.v1` должен дополняться схемами запросов/ответов до
  выпуска первой версии клиента.
- CI должен включать тесты на маршрутизацию провайдеров и бюджетирование
  запросов; эти задачи остаются в бэклоге.
- Плагины обязаны указывать поддерживаемый вариант клиента (semver) в своих
  дескрипторах.

## Связанные артефакты
- `<<AC_ANCHOR|CONTRACT|CORE|llm-client@v1>>`
- `<<AC_ANCHOR|CONTRACT|PLUGIN|contract@v1>>`
- `<<AC_ANCHOR|ROADMAP|GLOBAL|baseline@v1>>`
- `<<AC_ANCHOR|METRIC|PROJECT|registry@v1>>`

## Дальнейшие шаги
1. Зафиксировать структуру `llm-profiles.yaml` и шаблон адаптеров.
2. Добавить ADR по выбору базового провайдера (sandbox) и политике тестовых
   ключей.
3. Описать тестовую стратегию для клиента в разделе `/tests/core`.

## Журнал изменений
- 2025-09-17 — первый выпуск ADR, статус Accepted.
